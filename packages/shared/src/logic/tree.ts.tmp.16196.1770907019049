/**
 * The Calisthenics Progression Tree
 *
 * This module defines the exercise progression system used in DailyArc.
 * Each exercise has a level, prerequisites, and mastery criteria.
 */
import { SkillNode } from '../schemas/exercise'
import { User } from '../schemas/user'
import { calculateRelativeStrength } from './volume'

export interface ExerciseNode {
  /** Unique identifier for the exercise */
  id: string
  /** Display name of the exercise */
  name: string
  /** Progression logical depth (visual layer) */
  level: number
  /** Recommended number of sets */
  sets: number
  /** Recommended number of reps per set */
  reps: number
  /** Brief description of the exercise form */
  description: string
  /** Category/muscle group */
  category: 'push' | 'pull' | 'legs' | 'core'
  /** Prerequisites (exercise IDs that must be mastered first) */
  prerequisites: string[]
}

/**
 * The Push-up Progression Arc
 * Graph-based dependency tree.
 */
export const CALISTHENICS_TREE: ExerciseNode[] = [
  {
    id: 'wall-pu',
    name: 'Wall Pushups',
    level: 1,
    sets: 3,
    reps: 20,
    description: 'Stand arm-length from wall, push away.',
    category: 'push',
    prerequisites: [],
  },
  {
    id: 'incline-pu',
    name: 'Incline Pushups',
    level: 2,
    sets: 3,
    reps: 15,
    description: 'Hands on elevated surface, full ROM.',
    category: 'push',
    prerequisites: ['wall-pu'],
  },
  {
    id: 'knee-pu',
    name: 'Knee Pushups',
    level: 3,
    sets: 3,
    reps: 15,
    description: 'Standard pushup position on knees.',
    category: 'push',
    prerequisites: ['incline-pu'],
  },
  {
    id: 'standard-pu',
    name: 'Standard Pushups',
    level: 4,
    sets: 4,
    reps: 12,
    description: 'Full pushup with strict form.',
    category: 'push',
    prerequisites: ['knee-pu'], // Hard gate
  },
  {
    id: 'diamond-pu',
    name: 'Diamond Pushups',
    level: 5,
    sets: 4,
    reps: 10,
    description: 'Hands together forming a diamond.',
    category: 'push',
    prerequisites: ['standard-pu'], // Must master Standard first
  },
  {
    id: 'archer-pu',
    name: 'Archer Pushups',
    level: 6,
    sets: 3,
    reps: 8,
    description: 'Wide stance, shift weight side to side.',
    category: 'push',
    prerequisites: ['standard-pu'], // Branching path: can be done after Standard
  },
  {
    id: 'pseudo-planche',
    name: 'Pseudo Planche',
    level: 7,
    sets: 3,
    reps: 8,
    description: 'Hands by waist, lean forward.',
    category: 'push',
    prerequisites: ['diamond-pu'],
  },
  {
    id: 'one-arm-pu',
    name: 'One-Arm Pushup',
    level: 8,
    sets: 3,
    reps: 5,
    description: 'Single arm pushup - the pinnacle.',
    category: 'push',
    prerequisites: ['archer-pu', 'pseudo-planche'], // Dual dependency example
  },

  // ─── Pull Progression ───
  {
    id: 'dead-hang',
    name: 'Dead Hang',
    level: 1,
    sets: 3,
    reps: 20, // 20 seconds hold
    description: 'Hang from bar with straight arms, relax shoulders.',
    category: 'pull',
    prerequisites: [],
  },
  {
    id: 'flex-hang',
    name: 'Flexed Arm Hang',
    level: 2,
    sets: 3,
    reps: 15, // 15 seconds hold
    description: 'Hang with arms bent at 90 degrees.',
    category: 'pull',
    prerequisites: ['dead-hang'],
  },
  {
    id: 'neg-pullup',
    name: 'Negative Pullups',
    level: 3,
    sets: 3,
    reps: 8,
    description: 'Jump to top, lower slowly for 3-5 seconds.',
    category: 'pull',
    prerequisites: ['flex-hang'],
  },
  {
    id: 'pullup',
    name: 'Strict Pullups',
    level: 4,
    sets: 4,
    reps: 8,
    description: 'Full range of motion, chin above bar.',
    category: 'pull',
    prerequisites: ['neg-pullup'],
  },
  {
    id: 'dip',
    name: 'Dips (Parallel Bars)',
    level: 4,
    sets: 3,
    reps: 8,
    description: 'Bodyweight dip with 90-degree elbow bend.',
    category: 'push',
    prerequisites: ['standard-pu'],
  },
  {
    id: 'muscle-up-transition',
    name: 'Muscle-Up Transition',
    level: 6,
    sets: 3,
    reps: 5,
    description: 'Jump to muscle-up top position, hold 2 seconds, dismount.',
    category: 'pull',
    prerequisites: ['pullup'],
  },
  {
    id: 'muscle-up',
    name: 'Strict Muscle-Up',
    level: 8,
    sets: 3,
    reps: 3,
    description: 'Pull above rings, press to support position.',
    category: 'pull',
    prerequisites: ['muscle-up-transition', 'dip'],
  },

  // ─── Core Progression ───
  {
    id: 'plank-30',
    name: 'Plank Hold (30s)',
    level: 1,
    sets: 3,
    reps: 30, // 30 second hold
    description: 'Hold plank position with neutral spine.',
    category: 'core',
    prerequisites: [],
  },
  {
    id: 'plank-60',
    name: 'Plank Hold (60s)',
    level: 2,
    sets: 3,
    reps: 60, // 60 second hold
    description: 'Extended plank hold, 60 seconds per rep.',
    category: 'core',
    prerequisites: ['plank-30'],
  },
  {
    id: 'l-sit-tuck',
    name: 'Tuck L-Sit',
    level: 5,
    sets: 3,
    reps: 5, // 5-10 second holds
    description: 'Legs tucked, hold body off ground 5-15 seconds.',
    category: 'core',
    prerequisites: ['plank-60', 'standard-pu'],
  },
  {
    id: 'l-sit-full',
    name: 'Full L-Sit',
    level: 7,
    sets: 3,
    reps: 3, // 5-10 second holds
    description: 'Legs straight parallel to ground, upper body support.',
    category: 'core',
    prerequisites: ['l-sit-tuck'],
  },
  {
    id: 'dragon-flag-negative',
    name: 'Dragon Flag Negative',
    level: 7,
    sets: 3,
    reps: 5,
    description: 'Jump to top, shoulders on bench, lower with control.',
    category: 'core',
    prerequisites: ['l-sit-full'],
  },
  {
    id: 'dragon-flag',
    name: 'Full Dragon Flag',
    level: 9,
    sets: 3,
    reps: 5,
    description: 'Full body raise from shoulders only, strict form.',
    category: 'core',
    prerequisites: ['dragon-flag-negative'],
  },

  // ─── Advanced Push ───
  {
    id: 'planche-lean',
    name: 'Planche Lean',
    level: 8,
    sets: 3,
    reps: 5, // 5-15 second holds
    description: 'Hands by hips, lean 45° forward, hold.',
    category: 'push',
    prerequisites: ['pseudo-planche'],
  },

  // ─── Advanced Pull ───
  {
    id: 'front-lever-hold',
    name: 'Front Lever Hold',
    level: 9,
    sets: 3,
    reps: 3, // 3-10 second holds
    description: 'Body parallel to ground, inverted position.',
    category: 'pull',
    prerequisites: ['pullup', 'l-sit-full'],
  },
]

/**
 * Check if an exercise is unlocked based on user's completed exercises.
 * @param exerciseId - The ID of the exercise to check
 * @param completedExerciseIds - Array of completed exercise IDs
 * @returns True if the exercise is unlocked (prerequisites met)
 */
export function isExerciseUnlocked(exerciseId: string, completedExerciseIds: string[]): boolean {
  const exercise = CALISTHENICS_TREE.find(ex => ex.id === exerciseId)
  if (!exercise) return false

  // If no prerequisites, it's always unlocked
  if (exercise.prerequisites.length === 0) return true

  // Check if all prerequisites are completed
  return exercise.prerequisites.every(prereqId => completedExerciseIds.includes(prereqId))
}

/**
 * Get all unlocked exercises for a user (Available to train)
 * @param completedExerciseIds - Array of completed exercise IDs
 * @returns Array of unlocked exercise nodes
 */
export function getUnlockedExercises(completedExerciseIds: string[]): ExerciseNode[] {
  return CALISTHENICS_TREE.filter(exercise => {
    // If already completed, it's technically "unlocked" but maybe we want "next available"?
    // For now, return everything that is accessible.
    return isExerciseUnlocked(exercise.id, completedExerciseIds)
  })
}

/**
 * Get the "Next Up" exercises (Unlocked but NOT completed)
 * @param completedExerciseIds - Array of completed exercise IDs
 */
export function getNextProgressions(completedExerciseIds: string[]): ExerciseNode[] {
  return CALISTHENICS_TREE.filter(
    ex => !completedExerciseIds.includes(ex.id) && isExerciseUnlocked(ex.id, completedExerciseIds)
  )
}

/**
 * Get the user's current highest level attained
 */
export function getMaxLevel(completedExerciseIds: string[]): number {
  let maxLevel = 0

  completedExerciseIds.forEach(id => {
    const node = CALISTHENICS_TREE.find(n => n.id === id)
    if (node && node.level > maxLevel) {
      maxLevel = node.level
    }
  })

  return maxLevel
}

/**
 * Get the current exercise based on completed level
 * @param completedLevel - Number of completed exercises (0 = none completed)
 * @returns The exercise the user is currently working on
 * @deprecated Use getNextProgressions instead
 */
export function getCurrentExercise(completedLevel: number): ExerciseNode | null {
  // Rough approximation for legacy compatibility
  if (completedLevel >= CALISTHENICS_TREE.length) return null
  return CALISTHENICS_TREE[completedLevel]
}

/**
 * Calculate progression percentage
 * @param completedLevel - Number of completed exercises
 * @returns Percentage of tree completion (0-100)
 */
export function getProgressionPercentage(completedLevel: number): number {
  return Math.round((completedLevel / CALISTHENICS_TREE.length) * 100)
}

// =============================================================================
// Phase 2: Generic Tree Logic (Hybrid Support)
// =============================================================================

/**
 * Generic version of isExerciseUnlocked that works for any SkillNode tree.
 */
export function isNodeUnlocked(
  nodeId: string,
  completedNodeIds: string[],
  tree: SkillNode[]
): boolean {
  const node = tree.find(n => n.id === nodeId)
  if (!node) return false

  // If no prerequisites, it's unlocked (unless it has cross-prereqs, handled separately usually?
  // Actually, standard prereqs are strictly checking completed IDs)
  if (node.prerequisites.length === 0) return true

  return node.prerequisites.every(prereqId => completedNodeIds.includes(prereqId))
}

/**
 * Checks if cross-modality prerequisites are met (e.g. Squat 1.5x BW for Shrimp Squat).
 * @deprecated This function is not currently used. User schema doesn't have powerliftingStats yet.
 */
export function areCrossPrerequisitesMet(node: SkillNode): boolean {
  // TODO: Implement when User schema includes powerliftingStats
  if (!node.crossPrerequisites || node.crossPrerequisites.length === 0) return true
  return true
}

/**
 * Generic version of getNextProgressions.
 */
export function getNextProgressionsFromTree(
  completedIds: string[],
  tree: SkillNode[]
): SkillNode[] {
  return tree.filter(node => {
    const isCompleted = completedIds.includes(node.id)
    if (isCompleted) return false

    const standardUnlocked = isNodeUnlocked(node.id, completedIds, tree)
    // improved: we should also check cross prereqs here if we had user stats,
    // but this function signature doesn't have user stats.
    // The consumer should filter by cross-prereqs if needed, or we update signature.
    // For now, let's return standard unlocked nodes.
    return standardUnlocked
  })
}
